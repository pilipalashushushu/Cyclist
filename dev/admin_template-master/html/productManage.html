<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>CYCLIST 商品管理</title>
  <!-- Icons-->
  <link href="node_modules/@coreui/icons/css/coreui-icons.min.css" rel="stylesheet">
  <link href="node_modules/flag-icon-css/css/flag-icon.min.css" rel="stylesheet">
  <link href="node_modules/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="node_modules/simple-line-icons/css/simple-line-icons.css" rel="stylesheet">
  <!-- Main styles for this application-->
  <link href="css/style.css" rel="stylesheet">
  <style>
      #imgShow img{
        width: 200px;
        height: 200px;
      }
  </style>
</head>

<body class="app header-fixed sidebar-fixed aside-menu-fixed sidebar-lg-show">
 <!-- top_header -->
 @@include('layout/top_header.html')
  <div class="app-body">
    <div class="sidebar">
      <!-- sidebar menu-->
      @@include('layout/sidebar_nav.html')
      <button class="sidebar-minimizer brand-minimizer" type="button"></button>
    </div>
    <main class="main">
      <!-- Breadcrumb-->
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="blank.html">首頁</a>
        </li>
        <li class="breadcrumb-item">
            <a href="productManage.html">商品管理</a>
        </li>
        <!-- Breadcrumb Menu-->
      </ol>
      <div class="container-fluid">
       <!-- 中間內容 -->
       <div class="row prdAdd">
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">新增商品</div>
                    <div class="card-body">
                        <form action="" method="POST" enctype="multipart/form-data" id="uploadForm">
                        <table class="table table-responsive-sm table-sm">
                            <tr>
                                <th>輸入車種編號</th>
                                <td>
                                    <input class="form-control prodType" type="text" name="prodType">
                                </td>
                            </tr>
                            <tr>
                                <th>商品編號</th>
                                <td>
                                    <input class="form-control prodNo" type="text" name="prodNo">
                                </td>
                            </tr>
                            <tr>
                                <th>商品名稱</th>
                                <td>
                                    <input class="form-control prodName" type="text" name="prodName">
                                </td>
                            </tr>
                            <tr>
                                <th>商品價格</th>
                                <td>
                                    <input class="form-control prodPrice" type="text" name="prodPrice">
                                </td>
                            </tr>
                            <tr>
                                <th>商品規格</th>
                                <td>
                                    <input class="form-control prodSpec" type="text" name="prodSpec">
                                </td>
                            </tr>
                            <tr>
                                <th>商品主色</th>
                                <td>
                                    <input class="form-control prodColor" type="text" name="prodColor">
                                </td>
                            </tr>
                            <tr>
                                <th>商品等級</th>
                                <td>
                                    <input class="form-control prodLv" type="text" name="prodLv">
                                </td>
                            </tr>
                            <tr>
                                <th>速度</th>
                                <td>
                                    <input class="form-control prodSpeed" type="text" name="prodSpeed">
                                </td>
                            </tr>
                            <tr>
                                <th>避震</th>
                                <td>
                                    <input class="form-control prodAvoid" type="text" name="prodAvoid">
                                </td>
                            </tr>
                            <tr>
                                <th>商品說明</th>
                                <td>
                                    <textarea class="form-control prodDetail" rows="3" name="prodDetail"></textarea >
                                </td>
                            </tr>
                            <tr>
                                <th>商品圖片</th>
                                <td>
                                    <input class="form-control bikeSrc" type="file" id="imgSrc" name="upFile">
                                    <img id="imgPreview">
                                </td> 
                            </tr>
                        </table>
                        <div class="row">
                            <div class="col-6 col-sm-4 col-md-2 col-xl mb-3 mb-xl-0">
                                <button class="btn btn-pill btn-block btn-primary" type="submit" id="saveImg">確認新增</button>
                            </div>
                            <div class="col-6 col-sm-4 col-md-2 col-xl mb-3 mb-xl-0">
                                <button class="btn btn-pill btn-block btn-secondary clearAll" type="reset">取消清除</button>
                            </div>
                        </div>
                        </form>
                    </div>
                </div>
            </div> <!--col-lg-4-end-->

            
        </div>

       <!-- end -->
      </div>
    </main>
  </div>
  @@include('layout/footer.html')
  <!-- CoreUI and necessary plugins-->
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/popper.js/dist/umd/popper.min.js"></script>
  <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="node_modules/pace-progress/pace.min.js"></script>
  <script src="node_modules/perfect-scrollbar/dist/perfect-scrollbar.min.js"></script>
  <script src="node_modules/@coreui/coreui/dist/js/coreui.min.js"></script>
  <script>
        //從資料庫撈取資料append到網頁
        $('document').ready(function(){
          function prdManage(){
          let xhr = new XMLHttpRequest();
          xhr.onload = function(){
            if(xhr.status == 200){ //server OK
              let dataString = JSON.parse(xhr.responseText);
              let htmlStr = '';
              for (i = 0; i < dataString.length; i++) {
                        htmlStr = '';
                        htmlStr += `<div class="col-lg-4">`;
                        htmlStr += `<div class="card">`;
                        htmlStr += `<div class="card-header">編號<span class="prodChange">${dataString[i].prodNo}</span></div>`;
                        htmlStr += `<div class="card-body">`;
                        htmlStr += `<form action="" method="get" enctype="multipart/form-data">`;
                        htmlStr += `<table class="table table-responsive-sm table-sm">`;
                        if(dataString[i].prodType == '1'){
                            htmlStr += `<tr><th>商品總類</th><td>越野車</td></tr>`;
                        }else if(dataString[i].prodType == '2'){
                            htmlStr += `<tr><th>商品總類</th><td>公路車</td></tr>`;
                        }else{
                            htmlStr += `<tr><th>商品總類</th><td>城市車</td></tr>`;
                        }
                        htmlStr += `<tr><th>商品名稱</th><td>${dataString[i].prodName}</td></tr>`;
                        htmlStr += `<tr><th>商品價格</th><td>${dataString[i].prodPrice}</td></tr>`;
                        htmlStr += `<tr><th>商品規格</th><td>${dataString[i].prodSpec}</td></tr>`;
                        htmlStr += `<tr><th>商品主色</th><td>${dataString[i].prodColor}</td></tr>`;
                        htmlStr += `<tr><th>商品等級</th><td>${dataString[i].prodLv}</td></tr>`;
                        htmlStr += `<tr><th>速度</th><td>${dataString[i].prodSpeed}</td></tr>`;
                        htmlStr += `<tr><th>避震</th><td>${dataString[i].prodAvoid}</td></tr>`;
                        htmlStr += `<tr><th>商品說明</th><td><textarea  rows="5" cols="20">${dataString[i].prodDetail}</textarea></td></tr>`;
                        htmlStr += `<tr><th>商品圖片</th><td id="imgShow"><img src="./images/${dataString[i].prodPic}"></td></tr>`;
                        htmlStr += `<tr><th>上下架狀態</th><td><label class="switch switch-3d switch-success">`;
                                    if(`${dataString[i].prodStat}`== 1){
                                    htmlStr +=`<input class="switch-input prodStatus" type="checkbox" checked>`;
                                    }else{
                                    htmlStr +=`<input class="switch-input prodStatus" type="checkbox">`; 
                                    }
                        htmlStr +=`<span class="switch-slider"></span></label></td></tr>`;   
                        htmlStr += `</table>`;                    
                        htmlStr += `</form></div></div></div>`;  
                        $('.prdAdd').append(htmlStr);                    
              }  
            }else{ //error
              alert(xhr.status);
            }
          } //xhr function end
          xhr.open("get", "./php/product.php", true);
          // xhr.setRequestHeader("content-type", "application/x-www-form-urlencoded");
          xhr.send( null );
          }
          prdManage();
//----------------------------------------------------------------------------
        //網頁展示圖片
        $('.prdAdd').on('change','.bikeSrc',function(){
            let bikeSrc = this;
            fileBikeSrc = this.files[0];
            let readFile = new FileReader();
            readFile.readAsDataURL(fileBikeSrc);
            readFile.addEventListener('load',function(){
                let image = document.getElementById('imgPreview');
                image.src = this.result;
                imgPreview.style.maxWidth = '400px';
                imgPreview.style.maxHeight = '300px';
            });
        });

//----------------------------------------------
        //利用ajax form上傳資料 
        $("#uploadForm").on('submit',(function(e){
            e.preventDefault();
            $.ajax({
                url: "./php/fileupload.php",
                type: "POST",
                data:  new FormData(this),
                contentType: false,
                cache: false,
                processData:false,
                success: function(data){
                    alert("新增商品成功");
                    location.reload();
                    // window.load("productManage.html", "_self");
                    
                },
                error: function(data){
                    alert("新增商品失敗");
                }               
            });
        }));
        


//--------------------------------------------------------------
        //更改上下架狀態
        $('body').on('change', '.prodStatus', function (){
            let prodNo = $(this).parent().parent().parent().parent().parent().parent().parent().parent().find('.prodChange').text();
            // alert( $(this).attr('checked') == "checked" );  
            console.log(prodNo);
            let value;
                if( $(this).attr('checked') == 'checked' ){
                        $(this).attr('checked', false);
                        value =0;  
                    }else{
                        $(this).attr('checked', true);
                        value = 1;
                    }  
                $.ajax({
                    type: 'POST',
                    url: `./php/delProd.php`,
                    data: {
                        prodNo,
                        action: 'changeStat',
                        value,
                    },
                    success: function (data) {
                            if(value == false){
                            alert("商品下架成功");
                        }else{
                            alert("商品上架成功");
                        }
                        },  
                })
            }); 
    


          }) //$ready-end
      </script>
     
</body>
</html>